name: Auto Commit and Push

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允許手動觸發
  schedule:
    - cron: '*/5 * * * *'  # 每5分鐘檢查一次

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    
    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 設定 Git 使用者資訊
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
      - name: 檢查變更並提交
        run: |
          echo "🔍 檢查檔案變更..."
          git add .
          
          if git diff --cached --quiet; then
            echo "✅ 沒有變更，跳過提交。"
          else
            echo "📝 發現變更，準備提交..."
            
            # 生成智能 commit 訊息
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            CHANGED_FILES=$(git diff --cached --name-only | tr '\n' ' ')
            
            COMMIT_MSG="Auto commit: $TIMESTAMP

變更檔案:
$(git diff --cached --name-only | sed 's/^/- /')

透過 GitHub Actions 自動提交"
            
            git commit -m "$COMMIT_MSG"
            echo "✅ 提交成功: $TIMESTAMP"
            
            # 推送到遠端
            git push origin main
            echo "🚀 推送成功"
          fi
          
      - name: 顯示提交歷史
        run: |
          echo "📊 最近 3 次提交:"
          git log --oneline -3
